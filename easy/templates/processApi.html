<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Testapi-流程测试</title>

    <link rel="icon" href="../static/images/favicon%202.ico">

    <link rel="stylesheet" href="../static/layui2.5.5/css/layui.css">
    <link rel="stylesheet" href="../static/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../static/css/soulTable.css">
    <link rel="stylesheet" href="../static/css/processApi.css">

    <script src="../static/layui2.5.5/layui.js"></script>
    <style>
        .layui-nav-itemed > .layui-nav-child {
            max-height: 300px !important;
            overflow-y: scroll !important;
        }
        .mydepned{
            display: none;
        }
    </style>

</head>
<body class="layui-layout-body">
<div>
    <!--创建用例-->
    <div class="layui-row" id="add_update_case" style="display:none;">
        <div class="layui-col-md11">
            <form class="layui-form" lay-filter="add_update_case">

                <div class="layui-form-item" style="margin-top: 20px;">
                    <label class="layui-form-label">系统角色</label>
                    <div class="layui-input-block">
                        <select name="identity" id="identity" lay-verify="required">
                            <option value=""></option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">所属模块</label>
                    <div class="layui-input-block">
                        <select name="belong" id="belong" lay-verify="required">
                            <option value=""></option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">负责人</label>
                    <div class="layui-input-block">
                        <select name="head" id="head" lay-verify="required">
                            <option value=""></option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">用例名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="casename" required lay-verify="required"
                               placeholder="请输入用例名称"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">请求地址</label>
                    <div class="layui-input-block">
                        <input type="text" name="url" required lay-verify="required" placeholder="请输入请求地址"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">请求方式</label>
                    <div class="layui-input-block">
                        <input type="radio" name="method" value="get" title="GET" checked>
                        <input type="radio" name="method" value="post" title="POST">
                        <input type="radio" name="method" value="put" title="PUT">
                        <input type="radio" name="method" value="delete" title="Delete">
                        <input type="radio" name="method" value="file" title="File">
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">Query Params</label>
                    <div class="layui-input-block">
                        <textarea name="params" placeholder="请输入内容" class="layui-textarea"></textarea>
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">Form Data</label>
                    <div class="layui-input-block">
                                <textarea name="body" id="body" placeholder="请输入内容"
                                          class="layui-textarea"></textarea>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">存有依赖</label>
                    <div class="layui-input-block">
                        <input type="radio" lay-filter="depend" name="depend" value="exist" title="存在">
                        <input type="radio" lay-filter="depend" checked name="depend" value="unexist" title="不存在">
                    </div>
                </div>


                <div class="layui-form-item mydepend" style="display: none;">
                    <label class="layui-form-label">替换区域</label>
                    <div class="layui-input-block">
                        <input type="checkbox"  name="params" value="params" title="params">
                        <input type="checkbox"  name="body" value="body" title="body">
                    </div>
                </div>


                <div class="layui-form-item mydepend" style="display: none;">
                    <label class="layui-form-label">依赖的ID</label>
                    <div class="layui-input-block">
                        <input type="text" name="dependid" placeholder="无依赖不必填" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item mydepend" style="display: none;">
                    <label class="layui-form-label">依赖的key</label>
                    <div class="layui-input-block">
                        <input type="text" name="dependkey" placeholder="无依赖不必填" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item mydepend" style="display: none;">
                    <label class="layui-form-label">替换的key</label>
                    <div class="layui-input-block">
                        <input type="text" name="replacekey" placeholder="无依赖不必填" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="add_update_case"
                                style="float: right;">立即提交
                        </button>
                        <button type="reset" class="layui-btn layui-btn-primary"
                                style="float: right;margin-right: 10px;">
                            重置
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!--添加编辑用户信息-->
    <div class="layui-row" id="add_update_role">
        <div class="layui-col-md11">
            <form class="layui-form" lay-filter="add_update_role">

                <div class="layui-form-item" style="margin-top: 20px;">
                    <label class="layui-form-label">系统</label>
                    <div class="layui-input-block">
                        <input type="text" id="system" name="system" required lay-verify="required"
                               autocomplete="off" class="layui-input" value="{{ system }}">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">角色</label>
                    <div class="layui-input-block">
                        <input type="text" id="role" name="role" required lay-verify="required"
                               placeholder="请输入角色名" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">账号</label>
                    <div class="layui-input-block">
                        <input type="text" id="username" name="username" required lay-verify="required"
                               placeholder="请输入账号" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">密码</label>
                    <div class="layui-input-block">
                        <input type="text" id="password" name="password" required lay-verify="required"
                               placeholder="请输入密码" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">令牌</label>
                    <div class="layui-input-block">
                        <input type="text" id="token" name="token"
                               placeholder="请输入令牌,可以不填" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">IP</label>
                    <div class="layui-input-block">
                        <input type="text" id="url" name="url" required lay-verify="required"
                               placeholder="请输入IP地址" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn layui-btn-warm" lay-submit lay-filter="add_update_role"
                                style="float: right;margin-left:5px;">立即提交
                        </button>
                        <button type="reset" style="float: right;" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!--导入测试用例-->
    <div class="layui-row" id="import_case" >
        <div class="layui-col-md11">
            <form class="layui-form" enctype="multipart/form-data" action="/publicapi/import_case/" method="post">

                <div class="layui-form-item" style="margin-top: 20px;">
                    <div class="layui-input-block">
                        <input type="file" name="file" id="filename">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="import_case" style="float: right;">上传</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!--设置定时任务-->
    <div class="layui-row" id="timing_task" >
        <div class="layui-col-md11">
            <form class="layui-form" lay-filter="example">

                {#				<div class="layui-form-item" style="margin-top: 20px;">#}
                {#					<label class="layui-form-label">开始时间</label>#}
                {#					<div class="layui-input-block" style="width: 80%">#}
                {#						<input type="text" name="date" id="test5" placeholder="HH:mm:ss" class="layui-input test-item">#}
                {#					</div>#}
                {#				</div>#}

                <div class="layui-form-item" style="margin-top: 20px;">
                    <label class="layui-form-label">结束时间</label>
                    <div class="layui-input-block">
                        <input type="text" name="date1" class="layui-input test-item" id="test5" placeholder="HH:mm:ss">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">时间间隔</label>
                    <div class="layui-input-block">
                        <input type="text" name="date2" class="layui-input test-item shijian" id="test5"
                               placeholder="开始运行时间等于现在时间加上时间间隔">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">运行的ID</label>
                    <div class="layui-input-block">
                        <input type="text" name="caseid" lay-verify="title" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item" style="margin-top: 20px;">
                    <div class="layui-input-block">
                        <button class="layui-btn" id="time" lay-submit lay-filter="example"
                                style="float: right;">确定
                        </button>
                        <button type="reset" class="layui-btn layui-btn-primary"
                                style="float: right;margin-right: 10px;">
                            重置
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!--进度条-->
    <div class="layui-row" id="progress_bar">
        <div class="layui-col-md11">
            <blockquote class="layui-elem-quote">
                <span>接口进度 (执行接口数/需要执行的接口总数)：</span>
                <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="demo">
                    <div class="layui-progress-bar" lay-percent="0%">
                    </div>
                </div>
            </blockquote>
        </div>
    </div>

    <!--编辑替换位置-->
    <div class="layui-row" id="replace_position" >
        <div class="layui-col-md11">
            <form class="layui-form" lay-filter="replace_position">

                <div class="layui-form-item" style="margin-top: 20px;">
                    <label class="layui-form-label">替换区域</label>
                    <div class="layui-input-block">
                        <input type="checkbox" name="params" value="params" title="Query区域">
                        <input type="checkbox" name="body" value="body" title="Body区域">
                    </div>
                </div>

                <div class="layui-form-item" style="margin-top: 30px;">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="replace_position"
                                style="float:right;background-color: yellowgreen;">确定
                        </button>
                    </div>
                </div>
            </form>
            +
        </div>
    </div>

</div>
<!--主题内容-table-->
<div id="layuibody" class="layui-body mybg" style="margin-bottom: -70px;">
    <div style="padding: 15px;">
        <!--  lay-separator="-"-->
        <div class="demoTable">
            <div class="layui-breadcrumb">
					<span class="layui-icon layui-icon-link" style="font-size: 22px;color: #fff;">
						<a href="" class="index" style="color: #fff;">http://amberdata.cn/{{ system }}api</a>
						<a class="kit-side-fold casetitle" style="font-size: 22px;color: #fff;">{{ crumbs }}</a>
					</span>
            </div>
            <div id="sousuo">
                <div class="layui-inline" style="margin-top: -7px;">
                    <input class="layui-input" name="id" id="demoReload" autocomplete="off" placeholder="请输入用例名称"
                           value="错误接口查询"
                           style="width:200px;color: #999999;">
                </div>
                <button class="layui-btn layui-icon layui-icon-search" data-type="reload"
                        style="margin-top: -7px;">搜索
                </button>
            </div>
            <table class="layui-hide" id="test" lay-filter="test"></table>
        </div>

    </div>
</div>


<!--数据表格JS-->
<script>
    // 自定义模块
    layui.config({
        base: './../static/layui2.5.5/lay/modules/',   // 模块目录
        version: 'v1.3.28'
    }).extend({             // 模块别名
        soulTable: 'soulTable'
    });

    layui.use(['table', "soulTable"], function (data) {
        var table = layui.table;
        soulTable = layui.soulTable;
        //第一个实例
        var layer = layui.layer;
        var index = layer.load(0); //添加laoding,0-2两种方式
        var myTable = table.render({
            elem: '#test'
            , url: '/api/v1/processapi/list/' //数据接口"exports"
            , toolbar: '#toolbarDemo'
            , defaultToolbar: [
                'filter', {title: '导出数据', layEvent: 'export_case', icon: 'layui-icon-download-circle'}, {
                    title: '全屏显示',
                    layEvent: 'fullScreen',
                    icon: 'layui-icon-top'
                }, {title: '导入数据', layEvent: 'import_case', icon: 'layui-icon-upload-circle'}, 'print']
            , title: '接口流程测试'
            , page: {groups: 5} //开启分页
            , loading: false
            , height: 'full-60'
            , drag: {toolbar: true}//实现固定列与非固定列之间的转换
            , rowDrag: {
                trigger: 'row', done: function (obj) {
                    // 完成时（松开时）触发
                    // 如果拖动前和拖动后无变化，则不会触发此方法
                    console.log(obj.row);// 当前行数据
                    console.log(obj.cache); // 改动后全表数据
                    console.log(obj.oldIndex); // 原来的数据索引
                    console.log(obj.newIndex); // 改动后数据索引
                    var l = [];
                    for (var i in obj.cache) {
                        l.push(obj.cache[i].caseid)
                    }
                    console.log(l);
                    $.ajax({
                        cache: false,
                        url: "/api/v1/publicapi/sort/",
                        type: 'POST',
                        data: {
                            "caseids": JSON.stringify(l),
                            "belong": "{{ belong }}",
                            "system": "{{ system }}",
                            "type": "process"
                        },
                        success: function (data) {
                            if (data.code === 1000) {
                                layer.msg(data.msg, {
                                    icon: 6, offset: "t"
                                })
                            } else {
                                layer.msg(data.error, {
                                    icon: 5, offset: "t"
                                })
                            }
                            $(".layui-laypage-btn").click();
                        },
                        error: function () {
                            layer.msg("回调失败", {
                                icon: 5,
                                offset: 't'
                            });
                        },
                    });
                }

            }//排序
            , size: 'lg'	//lg大尺寸 /sm小尺寸
            , skin: 'line' //行边框风格 /row列表框风格 /nob无边框风格
            , limit: 10
            , limits: [10, 20, 30, 50, 100, 200, 500]
            , where: {//额外参数
                belong: '{{ belong }}',
                system: "{{ system }}"
            }
            , contextmenu: {
                // 表头右键菜单配置
                header: [
                    {
                        name: '重载表格',
                        icon: 'layui-icon layui-icon-refresh-1',
                        click: function () {
                            table.reload(this.id)
                        }
                    }
                ]
            }
            , cols: [[ //表头, fixed: 'left'
                {type: 'checkbox'}
                , {title: '操作', toolbar: '#barDemo', width: 80, align: "left"}
                , {field: 'caseid', title: '序号', width: 60, align: "left"}
                , {field: 'identity', title: '角色', width: 170, align: "left"}
                , {
                    field: 'casename',
                    title: '接口名称',
                    width: 220,
                    align: "left",
                    excel: {color: '0040ff', bgColor: 'f3fef3'},
                    templet: "#casenameTpl",
                    children: [
                        {
                            elem: '#templateTable'
                            , url: "/singleapi/parameter_details/"
                            , where: function (row) {
                                console.log(row);
                                return {caseid: row.caseid}
                            }
                            , title: "请求参数详情"
                            , skin: 'line'
                            , size: "lg"
                            //, height: 'full-10'
                            , cols: [[
                                {
                                    field: 'parameterName',
                                    title: '参数名称',
                                    width: 220,
                                    align: "left",
                                    style: 'background-color: #eee;'
                                }
                                , {
                                    field: 'parameterThat',
                                    title: '参数说明',
                                    width: 250,
                                    align: "left",
                                    style: 'background-color: #eee;'
                                }
                                , {
                                    field: 'requestType',
                                    title: '请求类型',
                                    width: 150,
                                    align: "left",
                                    style: 'background-color: #eee;'
                                }
                                , {
                                    field: 'isMust',
                                    title: '是否必须',
                                    width: 150,
                                    align: "left",
                                    templet: "#methodTpl",
                                    sort: true,
                                    style: 'background-color: #eee;'
                                }
                                , {
                                    field: 'sample',
                                    title: '示例',
                                    width: 190,
                                    align: "left",
                                    style: 'background-color: #eee;'
                                }
                            ]]
                            , done: function (data) {
                                //console.log(data);
                                soulTable.render(this);
                            }

                        }
                    ]
                }// filter: true
                , {
                    field: 'url', title: '请求路径', width: 220, align: "left", templet: function (res) {
                        var a = res.url.split("/");
                        return '<span>' + a[a.length - 1] + '</span>'
                    }
                }
                , {field: 'method', title: '请求方式', width: 90, align: "left", templet: "#methodTpl"}
                , {field: 'params', title: 'Query参数', align: "left", event: 'params'}
                , {field: 'body', title: 'Body参数', align: "left", event: 'body'}
                , {field: 'depend_id', title: '依赖的ID', align: "left", event: "depend_id"}
                , {field: 'depend_key', title: '依赖的key', align: "left", event: "depend_key"}
                , {field: 'replace_key', title: '替换的key', align: "left", event: "replace_key"}
                , {field: 'replace_position', title: '替换的位置', align: "left", event: "replace_position"}
                , {
                    field: 'durantion',
                    title: '响应时长',
                    align: "left",
                    sort: true,
                    width: 100,
                    event: "durantion",
                    templet: function (res) {
                        if (res.duration < 1) {
                            let a = String(res.duration * 1000) + "毫秒";
                            return '<span>' + a + '</span>'
                        } else if (res.duration >= 1 && res.duration < 3) {
                            let b = String(res.duration) + "秒";
                            return '<span style="color: cornflowerblue;">' + b + '</span>'
                        } else {
                            let b = String(res.duration) + "秒";
                            return '<span style="color: deeppink;">' + b + '</span>'
                        }
                    }
                }
                , {
                    field: 'result', title: '响应结果', align: "left", event: "detail", templet: function (res) {
                        if (res.result == null) {
                            return '<span>' + res.result + '</span>'
                        } else if (res.result.indexOf("message") != -1 && res.result.indexOf("error") != -1) {
                            let b = JSON.parse(res.result);
                            return '<span style="color: red;">' + JSON.stringify(b["message"]) + '</span>'
                        } else {
                            return '<span>' + res.result + '</span>'
                        }
                    }
                }
                , {field: 'head', title: '负责人', width: 80, event: "head", align: "left"}//merge: true行合并

            ]]
            , filter: {
                items: ['column', 'editCondition', 'excel'] // 只显示表格列和导出excel两个菜单项
            }
            , id: 'testReload'
            , rowEvent: function (obj) {
                obj.tr.css({'background': '#5FB878', 'color': 'white'}).siblings().removeAttr('style')
            }
            , done: function (res) {   //返回数据执行回调函数
                layer.close(index);    //返回数据关闭loading
                soulTable.render(this);
            }
        });

        //搜索
        layui.$, active = {
            reload: function () {
                var demoReload = $('#demoReload');
                console.log(demoReload.val());
                //执行重载
                table.reload('testReload', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                    , where: {casename: demoReload.val()}
                }, 'data');
            }
        };

        $('.demoTable .layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        //头工具栏事件
        table.on('toolbar(test)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            console.log(checkStatus);
            switch (obj.event) {
                //执行用例
                case 'run_case':
                    var data = checkStatus.data;
                    var len = data.length;
                    console.log(data);
                    if (len == 0) {
                        layer.close(index);
                        layer.msg("请先选中需要执行的用例", {
                            icon: 2,
                            offset: "t"
                        });
                    } else {
                        var l = [];
                        for (i = 0; i < data.length; i++) {
                            var dic = {};
                            dic["caseid"] = data[i]["caseid"];
                            dic['identity'] = data[i]['identity'];
                            dic['casename'] = data[i]['casename'];
                            dic["url"] = data[i]['url'];
                            dic['method'] = data[i]['method'];
                            dic['params'] = data[i]['params'];
                            dic['body'] = data[i]['body'];
                            dic['depend_id'] = data[i]['depend_id'];
                            dic['depend_key'] = data[i]['depend_key'];
                            dic['replace_key'] = data[i]['replace_key'];
                            dic['replace_position'] = data[i]['replace_position'];
                            l.push(dic);
                        }
                        console.log(l);
                        $.ajax({
                            cache: false,
                            url: "/api/v1/processapi/run/",
                            dataType: 'json',
                            type: 'POST',
                            data: {
                                "request": JSON.stringify(l)
                            },
                            //请求前的处理,加载loading
                            beforeSend: function () {
                                if (data.length > 1) {
                                    document.getElementById("Runcase").setAttribute("disabled", true);
                                    document.getElementById("Runcase").innerHTML = "loading...";
                                    l_index = layer.msg('执行接口中，小伙伴请稍候~~', {icon: 16, time: false, shade: 0.5});
                                    //l_index = layer.load(0, {shade: [0.5, '#DBDBDB']}); //0.1透明度的白色背景
                                    var process = layer.open({
                                        type: 1,
                                        title: false,
                                        area: ['50%', ''],
                                        skin: "layui-layer-rim",
                                        //shade: 0.8,
                                        offset: "b",
                                        content: $("#progress_bar").html(),
                                        success: function () {
                                            layui.use('element', function () {
                                                var $ = layui.jquery
                                                    , element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
                                                var sitv = setInterval(function () {
                                                    $.ajax({
                                                        cache: false,
                                                        url: "/api/v1/processapi/run/",
                                                        dataType: 'JSON',
                                                        type: 'GET',
                                                        success: function (num_progress) {
                                                            console.log(num_progress);
                                                            element.progress('demo', num_progress + '%');
                                                            if (num_progress > 33 && num_progress < 66) {
                                                                $(".layui-progress-bar").addClass("layui-bg-orange");
                                                            } else if (num_progress >= 66 && num_progress < 100) {
                                                                $(".layui-progress-bar").removeClass("layui-bg-orange");
                                                                $(".layui-progress-bar").addClass("layui-bg-red");
                                                            } else if (num_progress == "100") {
                                                                $(".layui-progress-bar").removeClass("layui-bg-red");
                                                                clearInterval(sitv);
                                                                layer.close(process);
                                                            }
                                                        },
                                                        error: function (data) {
                                                            console.log(data);
                                                            layer.msg(data, {
                                                                offset: 't',
                                                                icon: 5
                                                            });
                                                        }
                                                    });

                                                }, 250);// 每10毫秒查询一次后台进度
                                            });
                                        }
                                    });
                                } else {
                                    document.getElementById("Runcase").setAttribute("disabled", true);
                                    document.getElementById("Runcase").innerHTML = "loading...";
                                    l_index = layer.msg('执行接口中，小伙伴请稍候~~', {icon: 16, time: false, shade: 0.5});
                                }

                            },
                            success: function (data) {
                                console.log(data);//object
                                if (len > 0) {
                                    if (data.errors > 0) {
                                        let failcases = data.failcases;
                                        let errors = data.errors;
                                        let pass = len - errors;
                                        console.log(typeof (errors))
                                        var result = layer.open({
                                            type: 1,
                                            title: false,
                                            shade: false,
                                            area: ['80%', '80%'],
                                            //content: $("#process_result").html(),
                                            content: '<div style="padding:15px;">' +
                                                //'<blockquote class="layui-elem-quote">所属项目：ERMS数字档案室系统</blockquote>'+
                                                '<fieldset class="layui-elem-field">' +
                                                '<legend>执行结果</legend>' +
                                                '<div class="layui-field-box">' +
                                                '<label>用例总数：</label>' +
                                                '<span style="color: blue" id="all_num"></span>、' +
                                                '<label>成功的用例数：</label>' +
                                                '<span style="color: yellowgreen" id="success_num"></span>、' +
                                                '<label>失败的用例数：</label>' +
                                                '<span style="color: red" id="fail_num"></span>' +
                                                '</div>' +
                                                '</fieldset>' +
                                                '<fieldset class="layui-elem-field layui-field-title">' +
                                                '<legend>执行失败的接口用例列表</legend>' +
                                                '<div class="layui-field-box" style="padding: 15px;">' +
                                                '<table class="layui-hide" id="templateTable"  lay-filter="templateTable"></table>' +
                                                '</div>' +
                                                '</fieldset>' +
                                                '</div>',
                                            success: function (data) {
                                                document.getElementById("all_num").innerText = len;
                                                $("#success_num").html(pass);
                                                $("#fail_num").html(errors);

                                                var myTable = table.render({
                                                    elem: '#templateTable'
                                                    , url: '/api/v1/processapi/result_list/'
                                                    , page: true
                                                    , toolbar: '#resultDemo'
                                                    //, height: 'full-20'
                                                    , limit: 10
                                                    , cols: [[
                                                        {type: 'checkbox'}
                                                        , {field: 'casename', title: '接口名称', width: 300, align: "left"}
                                                        , {
                                                            field: 'duration', width: 100, title: '响应时长', align: "left",
                                                            templet: function (res) {
                                                                if (res.duration < 1) {
                                                                    let a = String(res.duration * 1000) + "毫秒";
                                                                    return '<span>' + a + '</span>'
                                                                } else if (res.duration >= 1 && res.duration < 3) {
                                                                    let b = String(res.duration) + "秒";
                                                                    return '<span style="color: cornflowerblue;">' + b + '</span>'
                                                                } else {
                                                                    let b = String(res.duration) + "秒";
                                                                    return '<span style="color: deeppink;">' + b + '</span>'
                                                                }
                                                            }
                                                        }
                                                        , {
                                                            field: 'result',
                                                            title: '响应结果',
                                                            width: 800,
                                                            align: "left",
                                                            event: "detail",
                                                            templet: function (res) {
                                                                if (res.result == null) {
                                                                    return '<span>' + res.result + '</span>'
                                                                } else if (res.result.indexOf("message") != -1 && res.result.indexOf("error") != -1) {
                                                                    let b = JSON.parse(res.result);
                                                                    return '<span style="color: red;">' + JSON.stringify(b["message"]) + '</span>'
                                                                } else if (res.result != "") {
                                                                    let a = JSON.parse(res.result);
                                                                    return '<span>' + JSON.stringify(a) + '</span>'
                                                                } else {
                                                                    return '<span>' + res.result + '</span>'
                                                                }
                                                            }
                                                        }
                                                        , {field: 'head', width: 90, title: '负责人', align: "left"}
                                                    ]]
                                                    , where: {
                                                        caseids: JSON.stringify(failcases),
                                                        system: "{{ system }}"
                                                    }
                                                });
                                                //头工具栏事件
                                                table.on('toolbar(templateTable)', function (obj) {
                                                    var checkStatus = table.checkStatus(obj.config.id);
                                                    //console.log(checkStatus);
                                                    switch (obj.event) {
                                                        //发送钉钉消息
                                                        case 'dingding':
                                                            var data = checkStatus.data;
                                                            console.log(data);
                                                            if (data.length == 0) {
                                                                layer.close(index);
                                                                layer.msg("请先选中需要发送的接口", {
                                                                    icon: 2,
                                                                    offset: "t"
                                                                });
                                                            } else {
                                                                layer.confirm("你确定要发送接口请求结果给相应的负责人吗？\n注意:请求正常发送所有结果信息，请求失败发送错误内容", {
                                                                        icon: 3,
                                                                        btn: ["确定", "取消"]
                                                                    }, function () {
                                                                        var ids = "";
                                                                        for (i = 0; i < data.length; i++) {
                                                                            ids += data[i]["caseid"] + ",";
                                                                            console.log(ids);
                                                                        }
                                                                        $.ajax({
                                                                            cache: false,
                                                                            url: "/api/v1/ding_ding/",
                                                                            type: 'GET',
                                                                            data: {
                                                                                "caseid": ids,
                                                                                "isprocess": "yes"
                                                                            },
                                                                            //请求前的处理,加载loading
                                                                            beforeSend: function () {
                                                                                document.getElementById("Dingding").setAttribute("disabled", true);
                                                                                document.getElementById("Dingding").innerHTML = "loading...";
                                                                                l_index = layer.msg('发送钉钉中，小伙伴请稍候~~', {
                                                                                    icon: 16,
                                                                                    time: false,
                                                                                    shade: 0.5
                                                                                });
                                                                                //l_index = layer.load(0, {shade: [0.5, '#DBDBDB']}); //0.1透明度的白色背景
                                                                            },
                                                                            success: function (data) {
                                                                                if (data.code === 1001) {
                                                                                    layer.msg(data.msg, {
                                                                                        icon: 6,
                                                                                        offset: 't',
                                                                                    });
                                                                                } else {
                                                                                    layer.msg(data.error, {
                                                                                        icon: 5,
                                                                                        offset: 't',
                                                                                    });
                                                                                }


                                                                            },
                                                                            error: function (data) {
                                                                                console.log(data);
                                                                                layer.msg("回调失败", {
                                                                                    icon: 5,
                                                                                    offset: 't'
                                                                                });
                                                                            },
                                                                            complete: function () {
                                                                                document.getElementById("Dingding").removeAttribute("disabled");
                                                                                document.getElementById("Dingding").innerHTML = "钉钉通知";
                                                                                layer.close(l_index);
                                                                            }
                                                                        });

                                                                    }, function () {
                                                                        layer.msg(
                                                                            "取消发送钉钉消息",
                                                                            {icon: 1, offset: "t"}
                                                                        );
                                                                    }
                                                                );
                                                            }
                                                            break;
                                                    }

                                                });
                                                //监听行工具事件
                                                table.on('tool(templateTable)', function (obj) {
                                                    var data = obj.data;
                                                    //console.log(obj);
                                                    if (obj.event === 'detail') {
                                                        console.log(data.result);
                                                        //var strjson = JSON.parse(data.result);
                                                        layer.prompt({
                                                            formType: 2,//多行文本
                                                            value: data.result,
                                                            shade: false,
                                                            title: data.casename + "响应结果",
                                                            maxmin: true,
                                                            skin: "layui-layer-rim",//hui
                                                            closeBtn: 0,
                                                            zIndex: layer.zIndex,
                                                            area: ['750px', '500px'], //自定义文本域宽高
                                                            btn: ["点我查看详情", "关闭"],
                                                            yes: function () {
                                                                var index = layer.open({
                                                                    type: 2,
                                                                    title: data.casename + "详细信息",
                                                                    //shadeClose: true,
                                                                    shade: false,
                                                                    zIndex: layer.zIndex,
                                                                    maxmin: true, //开启最大化最小化按钮
                                                                    area: ['600px', '1200px'],
                                                                    content: "/detail_process_api/?id=" + data.caseid,
                                                                });
                                                                layer.full(index);
                                                            },
                                                            btn2: function (index) {
                                                                layer.close(index);
                                                            }
                                                        });
                                                    }

                                                });
                                            },
                                            btn: ['关闭'],
                                            yes: function () {
                                                layer.close(result);
                                                $(".layui-laypage-btn").click();
                                            }
                                        });
                                    } else {
                                        layer.msg("接口执行全部成功", {
                                            icon: 6,
                                            offset: 't',
                                        })
                                        $(".layui-laypage-btn").click();
                                    }
                                } else if (len == 1) {
                                    //处理单个接口执行
                                    let strjson = JSON.stringify(data, null, 4);
                                    layer.prompt({
                                        formType: 2,//多行文本
                                        value: strjson,
                                        title: '响应结果',
                                        maxmin: true, //允许全屏最小化
                                        anim: 4,//从左滚动进来
                                        //shade: 0.6, //遮罩透明度
                                        skin: "layui-layer-rim",
                                        //监听取消按钮
                                        zIndex: layer.zIndex,
                                        shade: false,
                                        btn: ["json.cn", "关闭"],
                                        yes: function () {
                                            layer.open({
                                                type: 2,
                                                title: "json.cn",
                                                //shadeClose: true,
                                                shade: false,
                                                zIndex: layer.zIndex,
                                                maxmin: true, //开启最大化最小化按钮
                                                area: ['893px', '600px'],
                                                content: 'https://www.json.cn',
                                                success: function () {
                                                    layer.setTop(layero);
                                                }
                                            });

                                        },
                                        btn2: function (index, layro) {//这里就是你要的
                                            layer.close(index);
                                            $(".layui-laypage-btn").click();
                                        },
                                        area: ['700px', '500px'] //自定义文本域宽高
                                    });
                                } else if (data.status_code == 500 || data.status_code == 401) {
                                    layer.msg(data.msg, {
                                        icon: 5,
                                        offset: 't',
                                    });
                                }
                            },
                            error: function (data) {
                                layer.msg("NameError", {
                                    icon: 5,
                                    offset: 't',
                                });
                            },
                            complete: function () {
                                document.getElementById("Runcase").removeAttribute("disabled");
                                document.getElementById("Runcase").innerHTML = "执行用例";
                                layer.close(l_index);
                            }
                        });
                    }
                    break;
                //发送钉钉消息
                case 'ding_ding':
                    var data = checkStatus.data;
                    console.log(data);
                    if (data.length == 0) {
                        layer.close(index);
                        layer.msg("请先选中需要发送的接口", {
                            icon: 2,
                            offset: "t"
                        });
                    } else {
                        layer.confirm("你确定要发送接口请求结果给相应的负责人吗？\n注意:请求正常发送所有结果信息，请求失败发送错误内容", {
                                icon: 3,
                                btn: ["确定", "取消"]
                            }, function () {
                                var ids = "";
                                for (i = 0; i < data.length; i++) {
                                    ids += data[i]["caseid"] + ",";
                                    console.log(ids);
                                }
                                $.ajax({
                                    cache: false,
                                    url: "/api/v1/publicapi/dingding/",
                                    type: 'GET',
                                    data: {
                                        "caseid": ids,
                                        "isprocess": "yes"
                                    },
                                    //请求前的处理,加载loading
                                    beforeSend: function () {
                                        l_index = layer.msg('发送钉钉中，小伙伴请稍候~~', {icon: 16, time: false, shade: 0.5});
                                        //l_index = layer.load(0, {shade: [0.5, '#DBDBDB']}); //0.1透明度的白色背景
                                    },
                                    success: function (data) {
                                        if (data.code === 1000) {
                                            layer.msg(data.msg, {
                                                icon: 6, offset: "t"
                                            })
                                        } else {
                                            layer.msg(data.error, {
                                                icon: 5, offset: "t"
                                            })
                                        }
                                    },
                                    error: function () {
                                        layer.msg("回调失败", {
                                            icon: 5,
                                            offset: 't'
                                        });
                                    },
                                    complete: function () {
                                        layer.close(l_index);
                                    }
                                });

                            }, function () {
                                layer.msg(
                                    "取消发送钉钉消息",
                                    {icon: 1, offset: "t"}
                                );
                            }
                        );
                    }
                    break;
                //导出用例
                case "export_case":
                    if (checkStatus.data.length > 0) {
                        soulTable.export(myTable, {
                            filename: '勾选数据.xlsx',
                            checked: true, // 只导出勾选数据
                            border: {
                                style: 'thin',
                                color: '000000'
                            },
                            head: { // 表头样式
                                family: 'helvetica', // 字体
                                size: 14, // 字号
                                color: 'FFFFFF', // 字体颜色
                                bgColor: 'ff8c00' // 背景颜色
                            },
                            font: { // 正文样式
                                family: 'Calibri', // 字体
                                size: 12, // 字号
                                color: '000000', // 字体颜色
                                bgColor: 'FFFFFF' //背景颜色t
                            }
                        });
                        layer.msg('操作成功', {icon: 6, offset: 't'});
                    } else {
                        layer.msg('请先勾选数据在导出！', {icon: 0, offset: 't'});
                    }
                    break;
                //全屏显示
                case "fullScreen":
                    var docE = document.documentElement;
                    if (docE.requestFullScreen) {
                        docE.requestFullScreen();
                    } else if (docE.mozRequestFullScreen) {
                        docE.mozRequestFullScreen();
                    } else if (docE.webkitRequestFullScreen) {
                        docE.webkitRequestFullScreen();
                    }
                    break;
                //导入用例
                case "import_case":
                    layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type: 1,
                        title: "导入用例",
                        area: ['35%', '30%'],
                        skin: "layui-layer-rim",
                        shade: 0.6,
                        content: $("#import_case").html()
                    });
                    break;
                //批量删除
                case "batch_delete":
                    var data = checkStatus.data;
                    layer.confirm('真的删除行么', function (index) {
                        console.log(data);
                        layer.close(index);
                        var l = [];
                        for (i = 0; i < data.length; i++) {
                            var dic = {};
                            dic["caseid"] = data[i]["caseid"];
                            l.push(dic);
                        }
                        console.log(l);
                        $.ajax({
                            cache: false,
                            url: "/api/v1/processapi/del_case/0/",
                            type: 'DELETE',
                            data: {
                                "ids": JSON.stringify(l),
                            },
                            success: function (data) {
                                if (data.code === 1000) {
                                    layer.msg(data.msg, {
                                        icon: 6, offset: "t"
                                    })
                                } else {
                                    layer.msg(data.error, {
                                        icon: 5, offset: "t"
                                    })
                                }
                                $(".layui-laypage-btn").click();
                            },
                            error: function (data) {
                                console.log(data);
                                layer.msg("回调失败", {
                                    icon: 5,
                                    offset: 't'
                                });
                            },
                        });
                    });
                    break;
                    //定时任务
                {#case "timing_task":#}
                {#    var data = checkStatus.data;#}
                {#    var ids = "";#}
                {#    for (i = 0; i < data.length; i++) {#}
                {#        ids += data[i]["caseid"] + ",";#}
                {#        console.log(ids);#}
                {#    }#}
                {#    var timetask = layer.open({#}
                {#        type: 1,#}
                {#        title: "设置定时任务",#}
                {#        area: ['40%', ''],#}
                {#        trigger: 'click',#}
                {#        skin: 'layui-layer-molv',#}
                {#        shade: 0.6,#}
                {#        content: $("#timing_task").html(),#}
                {#        success: function (layero, index) {#}
                {#            layui.use(['laydate', 'form'], function () {#}
                {#                var laydate = layui.laydate;#}
                {#                var form = layui.form;#}
                {#                lay('.shijian').each(function () {#}
                {#                    laydate.render({#}
                {#                        elem: this#}
                {#                        , type: 'time'#}
                {#                        , trigger: 'click'#}
                {#                    });#}
                {#                });#}
                {#                lay('.test-item').each(function () {#}
                {#                    laydate.render({#}
                {#                        elem: this#}
                {#                        , type: 'datetime'#}
                {#                        , trigger: 'click'#}
                {#                    });#}
                {#                });#}
                {##}
                {#                form.val("example", {#}
                {#                    "caseid": ids#}
                {#                });#}
                {#                form.on('submit(example)', function (data) {#}
                {#                    console.log(data.field.date1);#}
                {#                    console.log(data.field.date2);#}
                {#                    console.log(data.field.caseid);#}
                {#                    $.ajax({#}
                {#                        cache: false,#}
                {#                        url: "/api/v1/timetask/",#}
                {#                        type: 'POST',#}
                {#                        //async: false,#}
                {#                        data: {#}
                {#                            "date1": data.field.date1,#}
                {#                            "date2": data.field.date2,#}
                {#                            "caseid": data.field.caseid#}
                {#                        },#}
                {#                        success: function (data) {#}
                {#                            layer.msg(data, {#}
                {#                                icon: 6,#}
                {#                                offset: 't'#}
                {#                            });#}
                {#                        },#}
                {#                        error: function (data) {#}
                {#                            console.log(data);#}
                {#                            layer.msg(data, {#}
                {#                                icon: 5,#}
                {#                                offset: 't'#}
                {#                            });#}
                {#                        },#}
                {#                        complete: function () {#}
                {#                            layer.close(timetask)#}
                {##}
                {#                        }#}
                {#                    });#}
                {#                    return false;//阻止表单跳转#}
                {#                });#}
                {#            });#}
                {#        }#}
                {#    });#}
                    break;
                //导出报表
                case 'export_report':
                    var data = checkStatus.data;
                    console.log(data);
                    if (data.length == 0) {
                        layer.msg("请先选中需要执行的用例", {
                            icon: 2,
                            offset: "t"
                        });
                    } else {
                        var l = [];
                        for (i = 0; i < data.length; i++) {
                            var dic = {};
                            console.log(data[i]);
                            dic["url"] = data[i]["url"];
                            dic['duration'] = data[i]['duration'];
                            l.push(dic);
                        }
                        console.log(l);
                    }
                    $.ajax({
                        cache: false,
                        url: "/api/v1/publicapi/export_report/",
                        type: 'POST',
                        data: {
                            "request": JSON.stringify(l)
                        },
                        //请求前的处理,加载loading
                        beforeSend: function () {
                            l_index = layer.msg('执行接口中，小伙伴请稍候~~', {
                                icon: 16,
                                time: false,
                                shade: 0.5
                            });
                        },
                        success: function (data) {
                            console.log(data);
                            if (data.code === 1000) {
                                layer.msg(data.msg, {
                                    icon: 6, offset: "t"
                                });
                                layer.open({
                                    type: 2,
                                    title: "pycharts图表",
                                    shadeClose: true,
                                    shade: false,
                                    zIndex: layer.zIndex,
                                    maxmin: true, //开启最大化最小化按钮
                                    area: ['950px', '600px'],
                                    content: '/echart_report/',
                                    success: function () {
                                        layer.setTop(layero);
                                    }
                                });
                            } else {
                                layer.msg(data.error, {
                                    icon: 5, offset: "t"
                                })
                            }

                        },
                        error: function () {
                            layer.msg("回调失败", {
                                icon: 5,
                                offset: 't'
                            });
                        },
                        complete: function () {
                            layer.close(l_index);
                        }
                    });
            }

        });

        //监听行工具事件
        table.on('tool(test)', function (obj) {
            var data = obj.data;
            var id = data['caseid'];
            //点击result查看详情
            if (obj.event === 'detail') {
                console.log(data.result);
                //var strjson = JSON.parse(data.result);
                layer.prompt({
                    formType: 2,//多行文本
                    value: data.result,
                    shade: false,
                    title: data.casename + "响应结果",
                    //anim: 4,//从左滚动进来
                    maxmin: true,
                    skin: "layui-layer-rim",//hui
                    closeBtn: 0,
                    zIndex: layer.zIndex,
                    area: ['800px', '600px'], //自定义文本域宽高
                    btn: ["详情", "关闭"],
                    yes: function () {
                        var index = layer.open({
                            type: 2,
                            title: data.casename + "详细信息",
                            //shadeClose: true,
                            shade: false,
                            zIndex: layer.zIndex,
                            maxmin: true, //开启最大化最小化按钮
                            area: ['600px', '1200px'],
                            content: "/detail/?id=" + data.caseid,
                        });
                        layer.full(index);
                    },
                    btn2: function (index) {
                        layer.close(index);
                    }
                });
            }
            //删除接口用例
            else if (obj.event === 'del_case') {
                layer.confirm('真的删除行么', {icon: 2, title: "删除提示"}, function (index) {
                    console.log(obj.data);
                    //layer.msg("确定删除",{icon:1});
                    obj.del();//删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    //向服务端发送删除指令
                    var id = obj.data["caseid"];
                    console.log(id);
                    $.ajax({
                        cache: false,
                        url: "/api/v1/processapi/del_case/" + id + "/",
                        type: 'DELETE',
                        success: function (data) {
                            if (data.code === 1000) {
                                layer.msg(data.msg, {
                                    icon: 6, offset: "t"
                                })
                            } else {
                                layer.msg(data.error, {
                                    icon: 5, offset: "t"
                                })
                            }
                            $(".layui-laypage-btn").click();
                        },
                        error: function () {
                            layer.msg("回调失败", {
                                icon: 5,
                                offset: 't'
                            });
                        },
                    });
                });
            }
            //编辑请求Query
            else if (obj.event === 'params') {
                layer.prompt({
                    formType: 2
                    , value: data.params
                    , title: ["编辑Query parmas"]
                    , skin: "layui-layer-lan"
                    , shade: false
                    , area: ['500px', '300px'] //自定义文本域宽高

                }, function (value, index) {
                    console.log(value);
                    console.log(index);
                    $.ajax({
                        cache: false,
                        url: "/api/v1/processapi/update_case/" + id + '/',
                        type: 'POST',
                        async: false,
                        data: {
                            "params": value
                        },
                        success: function (data) {
                            if (data.code === 1000) {
                                layer.msg(data.msg, {
                                    icon: 6, offset: "t"
                                })
                            } else {
                                layer.msg(data.error, {
                                    icon: 5, offset: "t"
                                })
                            }
                        },
                        error: function () {
                            layer.msg("回调失败", {
                                icon: 5,
                                offset: 't'
                            });
                        },
                    });
                    //同步更新缓存对应的值
                    obj.update({
                        params: value
                    });
                    layer.close(index);
                });
            }
            //编辑请求体
            else if (obj.event === 'body') {
                layer.prompt({
                    formType: 2
                    , value: data.body
                    , title: ["编辑data forms"]
                    , skin: "layui-layer-lan"
                    , shade: 0.6
                    , area: ['600px', '400px'] //自定义文本域宽高
                    , maxlength: 500000

                }, function (value, index) {
                    console.log(value);
                    console.log(index);
                    $.ajax({
                        cache: false,
                        url: "/api/v1/processapi/update_case/" + id + '/',
                        type: 'POST',
                        async: false,
                        data: {
                            "body": value
                        },
                        success: function (data) {
                            if (data.code === 1000) {
                                layer.msg(data.msg, {
                                    icon: 6, offset: "t"
                                })
                            } else {
                                layer.msg(data.error, {
                                    icon: 5, offset: "t"
                                })
                            }
                        },
                        error: function () {
                            layer.msg("回调失败", {
                                icon: 5,
                                offset: 't'
                            });
                        },
                    });
                    //同步更新缓存对应的值
                    obj.update({
                        body: value
                    });
                    layer.close(index);

                });
            }
            //编辑依赖的id
            else if (obj.event === 'depend_id') {
                layer.prompt({
                    formType: 2
                    , value: data.depend_id
                    , title: ["编辑depend_id"]
                    , skin: "layui-layer-lan"
                    , shade: 0.6
                    , area: ['300px', '150px'] //自定义文本域宽高
                    , maxlength: 500000

                }, function (value, index) {
                    $.ajax({
                        cache: false,
                        url: "/api/v1/processapi/update_case/" + id + '/',
                        type: 'GET',
                        async: false,
                        data: {
                            "depend_id": value
                        },
                        success: function (data) {
                            if (data.code === 1000) {
                                layer.msg(data.msg, {
                                    icon: 6, offset: "t"
                                })
                            } else {
                                layer.msg(data.error, {
                                    icon: 5, offset: "t"
                                })
                            }
                        },
                        error: function () {
                            layer.msg("回调失败", {
                                icon: 5,
                                offset: 't'
                            });
                        },
                    });
                    //同步更新缓存对应的值
                    obj.update({
                        depend_id: value
                    });
                    layer.close(index);

                });
            }
            //编辑依赖的key
            else if (obj.event === 'depend_key') {
                layer.prompt({
                    formType: 2
                    , value: data.depend_key
                    , title: ["编辑depend_key"]
                    , skin: "layui-layer-lan"
                    , shade: 0.6
                    , area: ['300px', '150px'] //自定义文本域宽高
                    , maxlength: 500000

                }, function (value, index) {
                    console.log(value);
                    console.log(index);
                    $.ajax({
                        cache: false,
                        url: "/api/v1/processapi/update_case/" + id + '/',
                        type: 'GET',
                        async: false,
                        data: {
                            "depend_key": value
                        },
                        success: function (data) {
                            if (data.code === 1000) {
                                layer.msg(data.msg, {
                                    icon: 6, offset: "t"
                                })
                            } else {
                                layer.msg(data.error, {
                                    icon: 5, offset: "t"
                                })
                            }
                        },
                        error: function () {
                            layer.msg("回调失败", {
                                icon: 5,
                                offset: 't'
                            });
                        },
                    });
                    //同步更新缓存对应的值
                    obj.update({
                        depend_key: value
                    });
                    layer.close(index);

                });
            }
            //编辑替换的key
            else if (obj.event === 'replace_key') {
                layer.prompt({
                    formType: 2
                    , value: data.replace_key
                    , title: ["编辑replace_key"]
                    , skin: "layui-layer-lan"
                    , shade: 0.6
                    , area: ['300px', '150px'] //自定义文本域宽高
                    , maxlength: 500000

                }, function (value, index) {
                    $.ajax({
                        cache: false,
                        url: "/api/v1/processapi/update_case/" + id + '/',
                        type: 'GET',
                        async: false,
                        data: {
                            "replace_key": value
                        },
                        success: function (data) {
                            if (data.code === 1000) {
                                layer.msg(data.msg, {
                                    icon: 6, offset: "t"
                                })
                            } else {
                                layer.msg(data.error, {
                                    icon: 5, offset: "t"
                                })
                            }
                        },
                        error: function () {
                            layer.msg("回调失败", {
                                icon: 5,
                                offset: 't'
                            });
                        },
                    });
                    //同步更新缓存对应的值
                    obj.update({
                        replace_key: value
                    });
                    layer.close(index);

                });
            }
            //编辑替换的区域
            else if (obj.event === 'replace_position') {
                var update_head = layer.open({
                    type: 1
                    , title: ["编辑替换区域"]
                    , skin: "layui-layer-lan"
                    , shade: 0.6
                    , shadeClose: true
                    , moveOut: true
                    , area: ["30%", '25%'] //自定义文本域宽高
                    , content: $("#replace_position").html(),
                    success: function () {
                        layui.use('form', function () {
                            var form = layui.form;
                            //console.log(data.replace_position);
                            //let l = JSON.parse(data.replace_position);
                            //let res = [];
                            //if(l.length == 2){
                            //res.push(true);
                            //res.push(true)
                            //}else if(l.length == 1){
                            //    if (l[0] == "params") {
                            //        res.push(true);
                            //        res.push(false)
                            //    }else{
                            //        res.push(false);
                            //        res.push(true)
                            //    }
                            //}else {
                            //    res.push(false);
                            //    res.push(false)
                            //}
                            form.val("replace_position", {
                                //"params":res[0],
                                //"body":res[1]
                            });
                            //监听编辑用户信息，
                            form.on('submit(replace_position)', function (data) {
                                let position_arr = ["params", "body"];
                                let par = [];
                                position_arr.map(function (data) {
                                    //console.log($("input[name^=" + data + "]").next("div").hasClass("layui-form-checked"));
                                    if ($("input[name^=" + data + "]").next("div").hasClass("layui-form-checked")) {
                                        par.push(data);
                                    }
                                });
                                console.log(par);
                                let num = "";
                                if (par.length == 2) {
                                    num = 2
                                } else if (par.length == 1 && par.indexOf("params") == 0) {
                                    num = 0
                                } else if (par.length == 1 && par.indexOf("body") == 0) {
                                    num = 1
                                }
                                console.log("请求的replace_position为：" + String(num));
                                $.ajax({
                                    url: "/api/v1/processapi/update_case/" + obj.data['caseid'] + '/',
                                    type: 'GET',
                                    data: {
                                        "replace_position": num
                                    },
                                    success: function (data) {
                                        if (data.code === 1000) {
                                            layer.msg(data.msg, {
                                                icon: 6, offset: "t"
                                            })
                                        } else {
                                            layer.msg(data.error, {
                                                icon: 5, offset: "t"
                                            })
                                        }
                                        $(".layui-laypage-btn").click();
                                    },
                                    error: function () {
                                        layer.msg("回调失败", {
                                            icon: 5,
                                            offset: 't'
                                        });
                                    },
                                    complete: function () {
                                        layer.close(update_head);
                                    }

                                });
                                return false;//阻止表单跳转
                            });
                        })
                    }

                });
            }
            //编辑接口整体
            else if (obj.event === 'update_case') {
                get_role_by_system("option", "identity");
                get_belong_by_system("belong");
                get_head("head");
                var a = layer.open({
                    type: 1,
                    title: "编辑用例",
                    area: ['35%', "80%"],
                    skin: "layui-layer-molv",
                    shada: 0.6,
                    content: $("#add_update_case").html(),
                    success: function () {
                        layui.use(['form', "jquery"], function () {
                            var form = layui.form;
                            var caseid = data.caseid;
                            console.log(data);
                            form.val("add_update_case", {
                                "caseID": data.caseid,
                                "casename": data.casename,
                                "identity": data.identity,
                                "url": data.url,
                                "method": data.method,
                                "belong": data.belong,
                                "params": data.params,
                                "body": data.body,
                                "head": data.head,
                                //"isprocess": data.isprocess,
                                "dependid": data.depend_id,
                                "dependkey": data.depend_key,
                                "replacekey": data.replace_key,
                                //"replaceposition": data.replace_position,
                            });
                            //监听编辑用户信息，
                            form.on('radio(depend)', function (data) {
                                console.log(data.elem); //得到radio原始DOM对象
                                console.log(data.value); //被点击的radio的value值
                                if (data.value == "exist") {
                                    $(".mydepend").css("display", "block")
                                    console.log("我应该展现依赖相关内容")
                                } else {
                                    $(".mydepend").css("display", "none")
                                }
                            });
                            form.render('radio', 'depend'); //更新 lay-filter="depend" 所在容器内的全部 radio 状态
                            form.on('submit(add_update_case)', function (data) {
                                console.log(data.field);
                                let position_arr = ["params", "body"];
                                let par = [];
                                position_arr.map(function (data) {
                                    //console.log($("input[name^=" + data + "]").next("div").hasClass("layui-form-checked"));
                                    if ($("input[name^=" + data + "]").next("div").hasClass("layui-form-checked")) {
                                        par.push(data);
                                    }
                                });
                                console.log(par);
                                let num = "";
                                if (par.length == 2) {
                                    num = 2
                                } else if (par.length == 1 && par.indexOf("params") == 0) {
                                    num = 0
                                } else if (par.length == 1 && par.indexOf("body") == 0) {
                                    num = 1
                                }
                                console.log("请求的replace_position为：" + String(num));
                                $.ajax({
                                    cache: false,
                                    url: "/api/v1/processapi/update_case/" + id + "/",
                                    type: 'PUT',
                                    data: {
                                        "identity": data.field.identity,
                                        "casename": data.field.casename,
                                        "url": data.field.url,
                                        "caseID": data.field.caseID,
                                        "method": data.field.method,
                                        "belong": data.field.belong,
                                        "params": data.field.params,
                                        "isprocess": data.field.isprocess,
                                        "body": data.field.body,
                                        "depend_id": data.field.dependid,
                                        "depend_key": data.field.dependkey,
                                        "replace_key": data.field.replacekey,
                                        "replace_position": num,
                                        "system": "{{ system }}",
                                        "head": data.field.head

                                    },
                                    beforeSend: function () {
                                        l_index = layer.load(0, {shade: [0.5, '#DBDBDB']});
                                    },
                                    success: function (data) {
                                        if (data.code === 1000) {
                                            layer.msg(data.msg, {
                                                icon: 6, offset: "t"
                                            })
                                        } else {
                                            layer.msg(data.error, {
                                                icon: 5, offset: "t"
                                            })
                                        }
                                        $(".layui-laypage-btn").click();
                                    },
                                    error: function () {
                                        layer.msg("回调失败", {
                                            icon: 5,
                                            offset: 't'
                                        });
                                    },
                                    complete: function () {
                                        layer.close(l_index);
                                        layer.close(a);
                                    }

                                });
                                return false;//阻止表单跳转
                            });
                        });
                    }
                });

            }
        });
    });

</script>
<script>

    //获取责任者
    function get_head(id) {
        $.ajax({
            url: "/api/v1/publicapi/get_head/",
            type: 'GET',
            async: false,
            success: function (data) {
                var str = '';
                //data是数组时，index是当前元素的位置，value是值
                $.each(data, function (index, value) {
                    str += "<option value='" + value + "'>" + value + "</option>";
                });
                console.log(str);
                $('#'+id).empty();
                $('#'+id).append(str);

            },
            error: function () {
                layer.msg("回调失败", {
                    icon: 5,
                    offset: 't'
                });
            },
        });
        //console.log(res);
        //return res
    }

    //新建用例
    function add_case() {
        get_role_by_system("option", "identity");
        get_belong_by_system("belong");
        get_head("head");
        var Create_apicase = layer.open({
            //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
            type: 1,
            title: "新建用例",
            skin: "layui-layer-molv",
            shade: 0.6,
            area: ['35%', '80%'],
            //offset: 't',
            content: $("#add_update_case").html(),
            success: function () {
                layui.use(['form', "jquery"], function () {
                    var form = layui.form,
                        $ = layui.$;
                    form.val("add_update_case",{
                        "depend":"unexist"
                    });
                    form.on('radio(depend)', function(data){
                      console.log(data.elem); //得到radio原始DOM对象
                      console.log(data.value); //被点击的radio的value值
                        if (data.value == "exist"){
                            $(".mydepend").css("display","block")
                            console.log("我应该展现依赖相关内容")
                        }else{
                            $(".mydepend").css("display","none")
                        }
                    });
                    form.render('radio', 'depend'); //更新 lay-filter="depend" 所在容器内的全部 radio 状态
                    form.on('submit(add_update_case)', function (data) {
                        console.log(data.field);
                        let position_arr = ["params", "body"];
                        let par = [];
                        position_arr.map(function (data) {
                            //console.log($("input[name^=" + data + "]").next("div").hasClass("layui-form-checked"));
                            if ($("input[name^=" + data + "]").next("div").hasClass("layui-form-checked")) {
                                par.push(data);
                            }
                        });
                        console.log(par);
                        let num = "";
                        if (par.length == 2) {
                            num = 2
                        } else if (par.length == 1 && par.indexOf("params") == 0) {
                            num = 0
                        } else if (par.length == 1 && par.indexOf("body") == 0) {
                            num = 1
                        }
                        console.log("请求的replace_position为：" + String(num));
                        $.ajax({
                            cache: false,
                            url: "/api/v1/processapi/add_case/",
                            type: 'POST',
                            data: {
                                "identity": data.field.identity,
                                "casename": data.field.casename,
                                "url": data.field.url,
                                "method": data.field.method,
                                "belong": '{{ belong }}',
                                "params": data.field.params,
                                "body": data.field.body,
                                "depend_id": data.field.dependid,
                                "depend_key": data.field.dependkey,
                                "replace_key": data.field.replacekey,
                                "replace_position": num,
                                "system": "{{ system }}",
                                "head": data.field.head
                            },
                            beforeSend: function () {
                                l_index = layer.load(0, {shade: [0.5, '#DBDBDB']});
                            },
                            success: function (data) {
                                if (data.code === 1000) {
                                    layer.msg(data.msg, {
                                        icon: 6, offset: "t"
                                    })
                                } else {
                                    layer.msg(data.error, {
                                        icon: 5, offset: "t"
                                    })
                                }
                                $(".layui-laypage-btn").click();
                            },
                            error: function () {
                                layer.msg("回调失败", {
                                    icon: 5,
                                    offset: 't'
                                });
                            },
                            complete: function () {
                                layer.close(l_index);
                                layer.close(Create_apicase);
                            }

                        });
                        return false;//阻止表单跳转
                    });
                });
            }
        });
    }

    //获取模块参数
    function get_belong_by_system(id) {
        //var res = {};
        $.ajax({
            //cache: false,
            url: "/api/v1/menu/get_belong_by_system/",
            type: 'GET',
            async: false,
            data: {
                "system": '{{ system }}',
                "area": "process"
            },
            success: function (data) {
                //res = data;
                var str = '';
                //data是数组时，index是当前元素的位置，value是值
                $.each(data, function (index, value) {
                    str += "<option value='" + value + "'>" + value + "</option>";
                });
                console.log(str);
                $('#' + id).empty();
                $('#' + id).append(str);

            },
            error: function () {
                layer.msg("回调失败", {
                    icon: 5,
                    offset: 't'
                });
            },
        });
        //console.log(res);
        //return res
    }

    //获取系统角色
    function get_role_by_system(attrtype, id) {
        //attrtype：什么标签
        //id:父标签的id属性值
        $.ajax({
            //cache: false,
            url: "/api/v1/systemrole/get_role_by_system/",
            type: 'GET',
            async: false,
            data: {
                "system": '{{ system }}'
            },
            success: function (data) {
                console.log(data);
                console.log(typeof (data));
                var str = '';
                //data是obj时，index是key，value是值
                $.each(data, function (index, value) {
                    console.log(index);
                    console.log(value);
                    if (attrtype == "option") {
                        console.log("我渲染的" + id);
                        str += "<option value='" + value + "'>" + value + "</option>";
                        $('#' + id).empty();
                        $('#' + id).append(str);
                    } else if (attrtype == "input") {
                        console.log("我渲染的" + id);
                        str += "<input type=\"radio\" name=\"identity\" value='" + value + "' title='" + value + "'>";
                        $('#' + id).empty();
                        $('#' + id).append(str);
                    }

                });
                console.log(str);

            },
            error: function () {
                layer.msg("回调失败", {
                    icon: 5,
                    offset: 't'
                });
            },
        });
    }

    //添加用户角色
    function add_role() {
        var add_role = layer.open({
            type: 1,
            title: "添加用户角色",
            area: ['40%', ''],
            shade: 0.6,
            skin: "layui-layer-rim",
            content: $("#add_update_role").html(),
            success: function () {
                layui.use(['form', "jquery"], function () {
                    var form = layui.form;
                    $ = layui.$;
                    form.val("add_update_role", {
                        "role": "【】",
                        "password": "Y+zilsR88g9SZI8WOeHJlA=="
                    });
                    //监听编辑用户信息，
                    {#form.on('radio', function (data) {#}
                    {#    console.log(data.elem); //得到radio原始DOM对象#}
                    {#    console.log(data.value); //被点击的radio的value#}
                    {#    if (data.value == "erms") {#}
                    {#        $(".erms").show();#}
                    {#        $(".tdr").hide();#}
                    {#    } else if (data.value == "tdr") {#}
                    {#        $(".tdr").show();#}
                    {#        $(".erms").hide();#}
                    {#    }#}
                    //});
                    form.on('submit(add_update_role)', function (data) {
                        $.ajax({
                            cache: false,
                            url: "/api/v1/systemrole/add_role/",
                            type: 'POST',
                            data: {
                                "system": "{{ system }}",
                                "role": data.field.role,
                                "username": data.field.username,
                                "password": data.field.password,
                                "ip": data.field.url,
                                "token": data.field.token
                            },
                            success: function (data) {
                                if (data.code === 1000) {
                                    layer.msg(data.msg, {
                                        icon: 6, offset: "t"
                                    })
                                } else {
                                    layer.msg(data.error, {
                                        icon: 5, offset: "t"
                                    })
                                }
                                $(".layui-laypage-btn").click();

                            },
                            error: function () {
                                layer.msg("回调失败", {
                                    icon: 5,
                                    offset: 't'
                                });
                            },
                            complete: function () {
                                layer.close(add_role)

                            }
                        });
                        return false;//阻止表单跳转
                    });


                });
            }
        });

    }

    //获取用户信息
    function get_user_info() {
        var userinfo = layer.open({
            type: 1,
            title: "用户信息",
            area: ['70%', "70%"],
            skin: 'layui-layer-molv',
            shade: 0.6,
            content: '<div style="padding:15px;"><table id="roletable" lay-filter="roletable"></table></div>',
            success: function () {
                layui.use(["table"], function () {
                    var table = layui.table
                        , layer = layui.layer;
                    table.render({
                        elem: '#roletable'
                        , url: "/api/v1/systemrole/list/"
                        , limit: 10
                        , toolbar: '#roletoolbarDemo'
                        , height: 'full-420'
                        , page: true
                        , initSort: {
                            field: "system",
                            type: "desc"
                        },
                        where: {
                            "system": "{{ system }}"
                        },
                        id: "roletable"
                        , size: 'lg'
                        , cols: [[
                            {type: 'checkbox'},
                            {title: '操作', toolbar: '#rolebarDemo', width: 100, align: "left"}
                            , {field: 'role', title: '角色名', align: "left"}
                            , {field: 'username', title: '用户名', align: "left"}
                            , {field: 'password', title: '用户密码', align: "left"}
                            , {field: 'token', title: '请求令牌', align: "left"}
                            , {field: 'system', title: '所属系统', align: "left"}
                            , {field: 'ip', title: 'ip地址', align: "left"}
                        ]]
                    });
                    table.on('tool(roletable)', function (obj) {
                        //编辑角色
                        if (obj.event === 'update_role') {
                            var data = obj.data;
                            console.log(data);
                            var update_role = layer.open({
                                type: 1,
                                title: "编辑用户信息",
                                area: ['40%', ''],
                                shade: 0.6,
                                skin: "layui-layer-rim",
                                content: $("#add_update_role").html(),
                                success: function () {
                                    layui.use(['form', "jquery"], function () {
                                        var form = layui.form;
                                        $ = layui.$;
                                        form.val("add_update_role", {
                                            "role": data.role,
                                            "system": data.system,
                                            "url": data.ip,
                                            "token": data.token,
                                            "username": data.username,
                                            "password": data.password
                                        });
                                        let id = data.id;
                                        form.on('submit(add_update_role)', function (data) {
                                            $.ajax({
                                                cache: false,
                                                url: "/api/v1/systemrole/update_role/" + id + "/",
                                                type: 'PUT',
                                                data: {
                                                    "role": data.field.role,
                                                    "system": data.field.system,
                                                    "ip": data.field.url,
                                                    "token": data.field.token,
                                                    "username": data.field.username,
                                                    "password": data.field.password
                                                },
                                                success: function (data) {
                                                    if (data.code === 1000) {
                                                        layer.msg(data.msg, {
                                                            icon: 6, offset: "t"
                                                        })
                                                    } else {
                                                        layer.msg(data.error, {
                                                            icon: 5, offset: "t"
                                                        })
                                                    }
                                                    $(".layui-laypage-btn").click();
                                                },
                                                error: function () {
                                                    layer.msg("回调失败", {
                                                        icon: 5,
                                                        offset: 't'
                                                    });
                                                },
                                                complete: function () {
                                                    layer.close(update_role)

                                                }
                                            });
                                            return false;//阻止表单跳转
                                        });


                                    });
                                }
                            });

                        } else if (obj.event === 'del_role') {
                            layer.confirm('真的删除行么', {icon: 2, title: "删除提示"}, function (index) {
                                console.log(obj.data);
                                //layer.msg("确定删除",{icon:1});
                                obj.del();//删除对应行（tr）的DOM结构，并更新缓存
                                layer.close(index);
                                //向服务端发送删除指令
                                var id = obj.data["id"];
                                console.log(id);
                                $.ajax({
                                    url: "/api/v1/systemrole/del_role/" + id + "/",
                                    type: 'DELETE',
                                    success: function (data) {
                                        if (data.code === 1000) {
                                            layer.msg(data.msg, {
                                                icon: 6, offset: "t"
                                            })
                                        } else {
                                            layer.msg(data.error, {
                                                icon: 5, offset: "t"
                                            })
                                        }
                                        $(".layui-laypage-btn").click();
                                    },
                                    error: function () {
                                        layer.msg("回调失败", {
                                            icon: 5,
                                            offset: 't'
                                        });
                                    },
                                });
                            });
                        }

                    });
                    table.on('toolbar(roletable)', function (obj) {
                        var checkStatus = table.checkStatus(obj.config.id);
                        switch (obj.event) {
                            //添加角色
                            case 'add_role':
                                add_role();
                                break;
                            case "get_token":
                                //获取token
                                var res = checkStatus.data;
                                console.log(res);
                                let list_id = [];
                                for(i=0;i<res.length;i++){
                                    list_id.push(res[i].id)
                                }
                                console.log(list_id);
                                $.ajax({
                                    cache: false,
                                    url: "/api/v1/systemrole/get_token_by_id/",
                                    type: 'PUT',
                                    data:{
                                      ids: JSON.stringify(list_id)
                                    },
                                    success: function (data) {
                                        //layer.closeAll();
                                        if (data.code === 1000) {
                                            layer.msg(data.msg, {
                                                icon: 6, offset: "t"
                                            })
                                        } else {
                                            layer.msg(data.error, {
                                                icon: 5, offset: "t"
                                            })
                                        }
                                        $(".layui-laypage-btn").click();
                                    },
                                    error: function () {
                                        layer.msg("回调失败", {
                                            icon: 5,
                                            offset: 't'
                                        });
                                    }

                                });
                        }
                    });
                });
            },
            btn: ['关闭'],
            yes: function () {
                layer.close(userinfo);
            }

        });
    }
</script>

<!--role表头按钮-->
<script type="text/html" id="roletoolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add_role">添加角色</button>
        <button class="layui-btn layui-btn-sm" lay-event="get_token">获取令牌</button>
    </div>
</script>
<!--role表行内按钮-->
<script type="text/html" id="rolebarDemo">
    <a class="layui-icon layui-icon-tips"
       style="color:#797979;font-size: 20px;padding:0 2px;vertical-align:middle;font-weight: lighter;"
       lay-event="update_role"></a>
    <a class="fa fa-trash-o" lay-event="del_role"
       style="color: #797979;font-size: 20px;padding:0 2px;vertical-align:middle;font-weight: lighter;"></a>
</script>

<script type="text/html" id="resultDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="dingding">钉钉通知</button>
    </div>
</script>
<!--表头按钮-->
<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button type="button" onclick="get_user_info()" class="layui-btn layui-btn-sm">用户信息</button>
        <button type="button" onclick="add_case()" class="layui-btn layui-btn-sm">添加接口</button>
        <button class="layui-btn layui-btn-sm" lay-event="batch_delete">批量删除</button>
        <button id="Dingding" class="layui-btn layui-btn-sm" lay-event="ding_ding">钉钉通知</button>
        <button id="Runcase" class="layui-btn layui-btn-sm" lay-event="run_case">执行接口</button>
        <button class="layui-btn layui-btn-sm" lay-event="export_report">生成报表</button>

    </div>
</script>
<!--行内按钮-->
<script type="text/html" id="barDemo">
    <a class="layui-icon layui-icon-tips"
       style="color:#797979;font-size: 20px;padding:0 2px;vertical-align:middle;font-weight: lighter;"
       lay-event="update_case"></a>
    <a class="fa fa-trash-o" lay-event="del_case"
       style="color: #797979;font-size: 20px;padding:0 2px;vertical-align:middle;font-weight: lighter;"></a>
</script>
<!--用例名字超链接模板-->
<script type="text/html" id="casenameTpl">
    <a href="/detail?processid={% verbatim %}{{d.caseid}}{% endverbatim %}" class="layui-table-link" target="_blank"
       style="color: blueviolet;">
        {% verbatim %}{{d.casename}}{% endverbatim %}
    </a>
</script>
<!--请求方式模板-->
<script type="text/html" id="methodTpl">
    {% verbatim %}{{#  if(d.method === 'get'){ }}{% endverbatim %}
    <span style="color: mediumpurple;">{% verbatim %}GET{% endverbatim %}</span>

    {% verbatim %}{{# } else if(d.method=== 'post') { }} {% endverbatim %}
    <span style="color: yellowgreen;">{% verbatim %}POST{% endverbatim %}</span>

    {% verbatim %}{{# } else if(d.method=== 'put') { }} {% endverbatim %}
    <span style="color: #00b4ef;">{% verbatim %}PUT{% endverbatim %}</span>

    {% verbatim %}{{# } else if(d.method=== 'delete' || d.method=== 'Delete' ) { }} {% endverbatim %}
    <span style="color: deeppink;">{% verbatim %}DELETE{% endverbatim %}</span>

    {% verbatim %}{{# } else if(d.method=== 'file' ) { }} {% endverbatim %}
    <span style="color: brown;">{% verbatim %}FILE{% endverbatim %}</span>

    {% verbatim %}{{# } else if(d.isMust.indexOf("false") != -1) { }} {% endverbatim %}
    <span style="color: lightslategrey;">{% verbatim %}{{ d.isMust }}{% endverbatim %}</span>

    {% verbatim %}{{# } else if(d.isMust.indexOf("true") != -1) { }} {% endverbatim %}
    <span style="color: deeppink;">{% verbatim %}{{ d.isMust }}{% endverbatim %}</span>

    {% verbatim %}{{#  } }}{% endverbatim %}
</script>

</body>
</html>